<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ärger mit Disk Images auf dem Mac</title>
    <meta name="viewport" content="width=device-width">
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta name="description" content="Michael Stapelberg’s private website, containing articles about computers and programming, mostly focused on Linux.">
    <link rel="canonical" href="https://michael.stapelberg.ch/posts/2007-12-18-aerger_mit_disk_images/">
    <meta name="author" content="Michael Stapelberg">
    <meta name="keywords" content="Michael, Stapelberg, Linux, Debian">
    <style type="text/css">
@font-face {
  font-family: 'Yanone Kaffeesatz Regular';
  font-style: normal;
  font-weight: 400;
  src: local('Yanone Kaffeesatz Regular'), url('/YanoneKaffeesatz-Regular.ttf') format('truetype');
}

@font-face {
  font-family: 'Droid Sans';
  font-style: normal;
  font-weight: normal;
  src: local('Droid Sans'), local('DroidSans'), url('/droid_sans.ttf') format('truetype');
}

@font-face {
  font-family: 'Droid Sans';
  font-style: normal;
  font-weight: bold;
  src: local('Droid Sans Bold'), local('DroidSans-Bold'), url('/droid_sans_bold.ttf') format('truetype');
}

body, td, th {
  font-family: 'Droid Sans', Verdana, Arial, Helvetica, sans-serif;
  font-size: 16px;
  color: #000;
} 
    </style>
    <link rel="stylesheet" href="/2.css" type="text/css">
    
    <link rel="stylesheet" href="/1.min.css" type="text/css"><link rel="alternate" href="/feed.xml" type="application/atom+xml" title="ATOM feed"></head>


  <body>
    <div class="container-fluid">
      <div class="row">
	<div id="menu" class="col-md-2">
  <div style="display: flex; align-items: center">
    <img src="/logo1x.jpg" srcset="/logo2x.jpg 2x, /logo3x.jpg 3x" width="45" style="border-radius: 40%; margin-right: .25em">
    <h1 style="letter-spacing: .75px">Michael Stapelberg</h1>
  </div>

  <ul class="menu_open">
    <li><a class="menu_item" href="/"><span class="menu_title">About</span></a></li>
    <li><a class="menu_item" href="/posts/"><span class="menu_title">Blog</span></a></li>
    <li><span class="menu_title">Programs</span>
      <div class="subitem">
	<ul class="menu_open">
	  <li><a class="menu_item" href="https://gokrazy.github.io/"><span class="menu_title">gokrazy</span></a></li>
	  <li><a class="menu_item" href="https://i3wm.org/"><span class="menu_title">i3</span></a></li>
	  <li><a class="menu_item" href="https://robustirc.net/"><span class="menu_title">RobustIRC</span></a></li>
	  <li><a class="menu_item" href="https://github.com/rtr7/router7/"><span class="menu_title">router7</span></a></li>
	  <li><a class="menu_item" href="https://www.x11vis.org/"><span class="menu_title">x11vis</span></a></li>
	  <li><a class="menu_item" href="/c128_kasse"><span class="menu_title">c128_kasse</span></a></li>
	</ul>
      </div>
    </li>

    <li><a class="menu_item" href="https://www.debian.org/"><span class="menu_title">Debian</span></a>
      <div class="subitem">
	<ul class="menu_open">
	  <li><a class="menu_item" href="https://codesearch.debian.net/"><span class="menu_title">Debian Code Search</span></a></li>
	  <li><a class="menu_item" href="https://manpages.debian.org/"><span class="menu_title">manpages.debian.org</span></a></li>
	</ul>
      </div>
    </li>

    <li><a class="menu_item" href="/talks"><span class="menu_title">Talks</span></a></li>
    <li><a class="menu_item" href="/series"><span class="menu_title">TV series</span></a></li>
  </ul>
</div>

	<div id="contentBox" class="col-md-10">
	  <h2 class="title">Ärger mit Disk Images auf dem Mac</h2>
	  <div style="margin-bottom: 2em">
	    <span id="date">published 2007-12-18, last modified 2018-03-18</span>
	    
	  
	  <span style="background-color: black; border-radius: 25%; padding-left: 0.1em; padding-right: 0.1em">
	    <a style="text-decoration: none; color: white" href="https://github.com/stapelberg/hugo/edit/master/content/posts/2007-12-18-Aerger_mit_Disk_Images.markdown">✎</a>
	  </span>
	  </div>
	  <div class="Artikel" id="content">
	    <h3>Wie alles begann</h3>

<p>
Nachdem ich das Firewirekabel einer Digitalkamera aus meinem Macbook zog,
zeigte dieses den sonst eher selten anzutreffenden „Greyscreen” – er war also
abgestürzt. Klar, niemand ist fehlerfrei und gerade bei Hardware wird’s
kritisch. Das sei dem MacBook also verziehen. <strong>Nach dem Neustart ließ
sich jedoch das Sparseimage mit meiner Musik nicht mehr öffnen, es sei defekt
heißt es.</strong> Ich habe natürlich ein Backup, aber komisch ist das schon.
Schließlich könnte mir das ja dann auch mit dem FileVault-Image passieren und
da wäre das schon schlimmer.
</p>

<h3>Sparseimage, FileVault?</h3>

<p>
Ein Sparseimage ist ein mitwachsender Container, in dem man Dateien und Ordner
ablegen kann. Da er Verschlüsselung unterstützt, kann man somit bestimmte
Dateien mit einem Passwortschutz versehen.
</p>

<p>
FileVault nennt sich die Technik, wie Apple Verschlüsselung für das komplette
Heimverzeichnis (wo also alle Dateien abgelegt werden) realisiert. Das ist auch
nichts anderes, als ein Sparseimage mit dem Namen des Benutzers in seinem
Heimverzeichnis (<code>/Users/michael/michael.sparseimage</code>) in meinem
Fall. Dieses Image wird dann beim Anmelden als Benutzer automatisch eingebunden
und wieder freigegeben, sobald man sich abmeldet.
</p>

<p>
Wenn man Dateien in einem solchen mitwachsenden Image löscht, wird der freie
Speicherplatz nicht sofort zur Verfügung gestellt. Stattdessen wird er beim
Herunterfahren des Rechners aufgeräumt – las ich zumindest in verschiedenen
Foren. Bei mir kam diese Aufforderung nie, sodass langsam aber sicher meine
Festplatte immer voller wurde.
</p>

<h3>Manuell aufräumen</h3>

<p>
Da ich mich ja nicht als Benutzer anmelden konnte, da sonst das Image verwendet
werden würde, startete ich meinen Mac in den Single-User-mode. Dadurch landet
man auf einer Konsole und kann dort – wenn man ein bisschen mit UNIX-Systemen
vertraut ist – normal arbeiten. Das verkleinern meines Images via <code>hdiutil
compact michael.sparseimage</code> tat jedoch garnichts. Im Nachhinein weiß
ich, wieso das so ist: Die Abfrage nach dem Passwort für das verschlüsselte
Image kommt standardmäßig in der grafischen Oberfläche und nicht an der
Konsole. Die grafische Oberfläche ist im Single-User-mode allerdings nicht
gestartet.
</p>

<p>
Ich legte also einen neuen Benutzer an, unter dem ich dann via
Festplattendienstprogramm wie ein Otto-normal-Macuser auch unter der grafischen
Oberfläche das Volume aufrämen wollte.  </p>

<p>
Da das Image normalerweise nur vom Benutzer michael gelesen werden darf, musste
ich noch kurz die Rechte via <code>sudo chmod 555 /Users/michael/*</code>
ändern (das muss man danach auch wieder ändern, nicht vergessen!).
</p>

<p>
Nachdem ich das Festplattendienstprogramm geöffnet hatte, machte ich mich
vergebens auf die Suche nach einer Option um Images aufzurämen. Falls jemand
weiß, wie man das über dieses Programm erledigt, so möge er mir das bitte
mitteilen. Was ich allerdings fand, was ein Knopf um „Freien Speicher [zu]
löschen”. Da ich das mit der gewünschten Funktion verwechselte, führte ich es
eben durch.
</p>

<p>
Der Mac legt hier nun eine sehr große Datei mit dem UNIX-Befehl „dd” an, sodass
die komplette Festplatte gefüllt und die freien Stellen auf der Datei somit
überschrieben werden. <strong>Allerdings hört dieser Befehl nicht auf, wenn die
Platte voll ist – nein, er schreibt einfach munter weiter!</strong> Die einzige
Möglichkeit bestand darin, via Terminal und „kill -9” den Prozess zu töten.
Daraufhin arbeitete das Festplattendienstprogramm etwas weiter, verweigerte
dann aber aufgrund Platzmangels (0 freie Bytes) den Dienst. Erst nachdem man
auch das Programm über die selbe Methode abschießt, kann man weiterarbeiten.
</p>

<p>
Aufräumen konnte ich das Diskimage schließlich im Terminal mit dem Befehl
<code>hdiutil compact -verbose /Users/michael/michael.sparseimage</code>. Das
dauerte ca 30 Minuten um 35 GB aufzurämen.
</p>

<p>
Einen Bugreport dazu habe ich bei Apple natürlich geschrieben, ich werde
bekanntgeben, sobald sich etwas ergibt.
</p>

	  </div>
	</div>
      </div>
    </div>
  </body>
</html>
