<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge"><title>mxallowd - Michael Stapelberg</title>

  <meta property="og:site_name" content="Michael Stapelberg">
  <meta property="og:title" content="mxallowd">
  <meta property="og:description" content=" An meine deutschen Besucher: Es gibt eine deutsche version dieser Seite. mxallowd is a daemon for linux/netfilter (using libnetfilter_queue) or BSD/pf (via pflog) which implements a slightly improved nolisting mechanism. Basically your nameserver has to be configured to return two MX ip addresses of which one does not run a mail server on port 25 (the one with higher priority). Most spammers try to connect directly to the first mailserver – mxallowd blocks that. You have to connect to the first one and then to the second one, direct connections do not work. Real mailservers (not spammers) have to try all MX ip addresses in order (sorted by priority) until they succeed in delivering the mail. ">
  
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
  <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/favicon-48x48.png" sizes="48x48">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
  <meta name="description" content=" An meine deutschen Besucher: Es gibt eine deutsche version dieser Seite. mxallowd is a daemon for linux/netfilter (using libnetfilter_queue) or BSD/pf (via pflog) which implements a slightly improved nolisting mechanism. Basically your nameserver has to be configured to return two MX ip addresses of which one does not run a mail server on port 25 (the one with higher priority). Most spammers try to connect directly to the first mailserver – mxallowd blocks that. You have to connect to the first one and then to the second one, direct connections do not work. Real mailservers (not spammers) have to try all MX ip addresses in order (sorted by priority) until they succeed in delivering the mail. ">
  <link rel="canonical" href="https://michael.stapelberg.ch/mxallowd.en/">
  <meta name="author" content="Michael Stapelberg">
  <style type="text/css">
    @font-face {
	font-family: 'Roboto Mono';
	src: url('/font/subset-RobotoMono-Regular.eot');
	src: local('Roboto Mono Regular'), local('RobotoMono-Regular'),
        url('/font/subset-RobotoMono-Regular.eot?#iefix') format('embedded-opentype'),
        url('/font/subset-RobotoMono-Regular.woff2') format('woff2'),
        url('/font/subset-RobotoMono-Regular.woff') format('woff'),
        url('/font/subset-RobotoMono-Regular.ttf') format('truetype');
	font-weight: normal;
	font-style: normal;
	font-display: swap;
    }

    @font-face {
	font-family: 'Roboto';
	src: url('/font/subset-Roboto-Bold.eot');
	src: local('Roboto Bold'), local('Roboto-Bold'),
        url('/font/subset-Roboto-Bold.eot?#iefix') format('embedded-opentype'),
        url('/font/subset-Roboto-Bold.woff2') format('woff2'),
        url('/font/subset-Roboto-Bold.woff') format('woff'),
        url('/font/subset-Roboto-Bold.ttf') format('truetype');
	font-weight: bold;
	font-style: normal;
	font-display: swap;
    }

    @font-face {
	font-family: 'Roboto';
	src: url('/font/subset-Roboto-Regular.eot');
	src: local('Roboto'), local('Roboto-Regular'),
        url('/font/subset-Roboto-Regular.eot?#iefix') format('embedded-opentype'),
        url('/font/subset-Roboto-Regular.woff2') format('woff2'),
        url('/font/subset-Roboto-Regular.woff') format('woff'),
        url('/font/subset-Roboto-Regular.ttf') format('truetype');
	font-weight: normal;
	font-style: normal;
	font-display: swap;
    }

    @font-face {
	font-family: 'Lato';
	src: url('/font/subset-Lato-Bold.eot');
	src: local('Lato Bold'), local('Lato-Bold'),
        url('/font/subset-Lato-Bold.eot?#iefix') format('embedded-opentype'),
        url('/font/subset-Lato-Bold.woff2') format('woff2'),
        url('/font/subset-Lato-Bold.woff') format('woff'),
        url('/font/subset-Lato-Bold.ttf') format('truetype');
	font-weight: bold;
	font-style: normal;
	font-display: swap;
    }

    body, td, th {
	font-family: 'Roboto';
	font-size: 16px;
	line-height: 150%;
	color: #000;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
	font-family: 'Lato';
	font-weight: bold;
	font-variant-ligatures: none;
	color: #000;
    }
  </style>

  
  <link rel="preload" href="/font/subset-Lato-Bold.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/font/subset-Roboto-Regular.woff2" as="font" type="font/woff2" crossorigin>

  

  
  <link rel="stylesheet" href="/1.min.css?cachebust=sha512-MmDletsiVVexqmh4i3stLXAHVECuOzqin3b%2babGWq5wv%2fwd%2f9IdQTTMV1IZowrB21EMrM9N1VHI17hmnyeCskw%3d%3d" type="text/css">
  <link rel="alternate" href="/feed.xml" type="application/atom+xml" title="ATOM feed">
</head>
<body>



<header id="ms_navbar">
  <a href="/">
<img
    src="/logo1x.jpg"
    srcset="/logo2x.jpg 2x, /logo3x.jpg 3x"
    width="42"
    height="52"
    alt="profile picture"
    title="profile picture">
</a>
  <div>
    <a href="/"><h1>Michael Stapelberg</h1></a>
    <nav id="ms_desktopnav">
      <ul>
	
    <li><a href="/" >About</a></li>
    <li><a href="/posts/" >Blog</a></li>
    <li><a href="/talks/" >Talks</a></li>
    <li><a href="/series/" >Series</a></li>

      </ul>
    </nav>
  </div>

  <div id="ms_burger_open">
    <label for="ms_burger"><svg viewBox="0 0 100 80" width="24" height="24">
	<rect width="100" height="17" rx="8" fill="white"></rect>
	<rect y="30" width="100" height="17" rx="8" fill="white"></rect>
	<rect y="60" width="100" height="17" rx="8" fill="white"></rect>
    </svg></label>
  </div>

  <input type="checkbox" id="ms_burger">

  <nav id="ms_navdrawer">
    <div id="ms_navdrawer_top">
      <div id="ms_navdrawer_search">
	<a href="/">
<img
    src="/logo1x.jpg"
    srcset="/logo2x.jpg 2x, /logo3x.jpg 3x"
    width="42"
    height="52"
    alt="profile picture"
    title="profile picture">

	<h1>Michael Stapelberg</h1></a>
      </div>
      <div id="ms_burger_close">
	<label for="ms_burger"><svg viewBox="0 0 110 110" width="24" height="24">
	    <line x1="10" y1="10" x2="100" y2="100" stroke="#047bc2" stroke-width="20" />
	    <line x1="100" y1="10" x2="10" y2="100" stroke="#047bc2" stroke-width="20" />
	</svg></label>
      </div>
    </div>

    <div id="ms_navdrawer_content">
      <ul>
	
    <li><a href="/" >About</a></li>
    <li><a href="/posts/" >Blog</a></li>
    <li><a href="/talks/" >Talks</a></li>
    <li><a href="/series/" >Series</a></li>

      </ul>
    </div>
  </nav>
</header>
<main>
      <div>
<h1 class="ms_title">mxallowd (2014)</h1>

<div class="ms_meta">
  <div id="ms_date">published 2014-11-07, last modified 2018-03-18</div>
  
  
  <div>
    <a href="https://github.com/stapelberg/hugo/edit/master/content/mxallowd.en.md"><img src="/Bilder/pen-square-solid.svg" width="18" height="20" alt="Edit Icon" title="Suggest a change to this article"></a>
  </div>
  
</div>
<div class="Artikel" id="content">
  <div id="ml">
		<p> An meine deutschen Besucher: Es gibt eine <a href="/mxallowd" id="ml_link">deutsche version</a> dieser Seite. </p>
	</div>
	<div id="content"><p>
mxallowd is a daemon for linux/netfilter (using libnetfilter_queue) or BSD/pf
(via pflog) which implements a slightly improved <a
href="http://nolisting.org/">nolisting</a> mechanism. Basically your nameserver
has to be configured to return two MX ip addresses of which one does not run a
mail server on port 25 (the one with higher priority). Most spammers try to
connect directly to the first mailserver – mxallowd blocks that. You have to
connect to the first one and then to the second one, direct connections do not
work. Real mailservers (not spammers) have to try all MX ip addresses in order
(sorted by priority) until they succeed in delivering the mail.
</p>
<p>
The problem with nolisting is that some spammers try (probably because of the
nolisting) to connect directly to the second MX ("direct-to-second-mx"). This
is where mxallowd turns in: You cannot connect to the second mailserver aswell,
except if you have tried connecting to the first mailserver before (you are
whitelisted then).
</p>
<p>
This problem could be solved using iptables with the module ipt_recent aswell,
if it wasn’t for one little detail: Some providers (for example Google Mail)
use the same DNS name but different ip addresses when trying the mailservers in
order. So ipt_recent, which works solely using ip addresses, does not let mails
from Google Mail through. mxallowd in contrary whitelists all ip addresses of
the DNS name (except if you specify the option --no-rdns-whitelist of course).
</p>
<h2>Setup on Linux</h2>
<p>
In order to let mxallowd handle the connections, one has to add the following
iptables-rule:
<pre>
iptables -A INPUT -p tcp --dport 25 -m state --state NEW -j NFQUEUE --queue-num 23
</pre>
<p>
If inserting this rule fails you have to insert the queue module into the
kernel using <code>modprobe nfnetlink_queue</code>.
</p>
<p>
You can modify this rule of course to handle, for example, only certain ip
addresses or to accept connections from certain ip addresses (whitelisting, use
-j ACCEPT at the end of the rule).
</p>
<h2>Setup on BSD</h2>
<p>
Your /etc/pf.conf could look like this:
</p>
<pre>
table  persist

real_mailserver="192.168.1.4"
fake_mailserver="192.168.1.3"

real_mailserver6="2001:dead:beef::1"
fake_mailserver6="2001:dead:beef::2"

pass in quick log on fxp0 proto tcp from  \
	     to $real_mailserver port smtp
pass in quick log on fxp0 inet6 proto tcp from  \
	     to $real_mailserver6 port smtp
block in log on fxp0 proto tcp \
	      to { $fake_mailserver $real_mailserver } port smtp
block in log on fxp0 inet6 proto tcp \
	      to { $fake_mailserver6 $real_mailserver6 } port smtp
</pre>
<p>
The important things are that the table mx-white exist and that the pass- and
the block-rules specify the log modifier. If you use another pflog-interface,
you can tell mxallowd this via parameter.
</p>
<h2>Help, i cannot send mails anymore!</h2>
<p>
That’s right – if you use the same mailserver to send your mails, your
mailclient will probably try only the first ip address (which does not run a
mailserver). I’d recommend sending mails via SMTPS (SSL) because its port (465)
will not be filtered if you don’t explicitly set it up (see "Setup").
Alternatively, you could run your mailserver additionally on another port which
only you use (spammers won’t do a portscan, if they don’t even use
standard-compliant mailers…). If you have a static ip address you can whitelist
it in iptables of course (see "Setup").
</p>
</div>
	<h3>Downloads</h3>
	<ul id="downloads"><li><a class="download_filename" href="/mxallowd/mxallowd.1.9.tar.bz2"><span class="download_name">mxallowd 1.9</span></a> (<span class="download_size">33K</span>, <a class="download_gpg" href="/mxallowd/mxallowd.1.9.tar.bz2.asc">GPG signature</a>)</li></ul>
	<h3>License</h3>
	<p><span class="name">mxallowd</span> is free open source software under the <span class="license">GPL2</span>.</p>
	<div id="development">
		<h3>Development</h3>
		<p>Current development can be followd <a class="dev_url" href="http://code.stapelberg.de/git/mxallowd">in gitweb</a>.</p>
	</div>
	<h3>Feedback</h3>
	<p>If you would like to drop me a message, please <a href="/Impressum">send me an email</a>.</p>
</div>
<div id="bmc">
  <p>
    Did you like this
    post? <a href="https://michael.stapelberg.ch/feed.xml">Subscribe to this
      blog’s RSS feed</a> to not miss any new posts!
  </p>
  <p>
    I run a blog since 2005, spreading knowledge and experience for over 20 years! :)
  </p>
  <p>
    If you want to support my work, you
    can <a href="https://www.buymeacoffee.com/stapelberg">buy me a coffee</a>.
  </p>
  <p>
    Thank you for your support! ❤️
  </p>
</div>

</div>

      </div>

    </main><div id="ms_footer">
  © 2025 Michael Stapelberg • all articles under <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons CC-BY license</a>
</div>
</body>
</html>
